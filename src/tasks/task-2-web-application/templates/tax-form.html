{% extends "main.html" %}
{% block content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"></script>
<form action = "http://localhost:5000/tax-direction" method = "POST">
    <div class="form-group">
        <input type="checkbox" id="consentBox" name="consent" value="True">
        <label for="consentBox">Would you like to suggest to your government how to use the above calculated amount for solving the problem specific to you?</label>
    </div>

    Add random generator for tax amount generator and add the price value.
    Take a unique identifier like email ID

    auto email of responses


    <br>
    <div>
      Specific Domains which you wish to focus on :
    </div>
    <div class="form-group">
        <input type="number" class="form-control" id="percentageTax" name="percent" placeholder="%">
    </div>

    <div class="form-group">
        <input type="text" class="form-control" id="domain" name="domainText" placeholder="Broad Domain">
    </div>

    <div class="form-group">
      <input type="text" class="form-control" id="problemStatement" name="problemText" placeholder="Problem Statement">
    </div>

    <div class="form-group">
      <input type="text" class="form-control" id="location" name="locationText" placeholder="Location or Beneficiary area">
    </div>

    <div class="form-group">
        <input type="text" class="form-control" id="suggestion" name="suggestionText" placeholder="Solution Suggestion">
    </div>

    <div class="container">
        <b>Coordinates</b>
        <form>
            <input type="text" name="lat" id="lat" size="12" value="" />
            <input type="text" name="lon" id="lon" size="12" value="" />
        </form>

        <b>Address Lookup</b>
        <div id="search">
            <input type="text" name="addr" value="" id="addr" size="58" />
            <button type="button" onclick="addr_search();">Search</button>
            <div id="results"></div>
        </div>

        <br />

        <div id="map"></div>
    </div>
	<button type="submit" class="btn btn-primary">Submit</button>

</form>

<script type="text/javascript">
    // New York
    var startlat = 40.75637123;
    var startlon = -73.98545321;

    var options = {
        center: [startlat, startlon],
        zoom: 9,
    };

    document.getElementById("lat").value = startlat;
    document.getElementById("lon").value = startlon;

    var map = L.map("map", options);
    var nzoom = 12;

    L.tileLayer("http://{s}.tile.osm.org/{z}/{x}/{y}.png", {
        attribution: "OSM",
    }).addTo(map);

    console.log(L);

    var myMarker = L.marker([startlat, startlon], {
        title: "Coordinates",
        alt: "Coordinates",
        draggable: true,
    })
        .addTo(map)
        .on("dragend", function () {
            // OSM Nomitatim documentation: http://wiki.openstreetmap.org/wiki/Nominatim
            var jsonQuery =
                "http://nominatim.openstreetmap.org/reverse?format=json&lat=" +
                myMarker.getLatLng().lat +
                "&lon=" +
                myMarker.getLatLng().lng +
                "&zoom=18&addressdetails=1";
            $.getJSON(jsonQuery).done(function (result_data) {
                console.log(result_data);

                var road;

                if (result_data.address.road) {
                    road = result_data.address.road;
                } else if (result_data.address.pedestrian) {
                    road = result_data.address.pedestrian;
                } else {
                    road = "Not defined!";
                }
                var popup_text =
                    "<b>Lat-lng:</b> " +
                    myMarker.getLatLng().lat +
                    ", " +
                    myMarker.getLatLng().lng +
                    // "</br><b>Address:</b> " + result_data.address +

                    "</br><b>road</b> " +
                    road +
                    ", " +
                    result_data.address.house_number +
                    "</br><b>District</b> " +
                    result_data.address.city_district +
                    "</br><b>City:</b> " +
                    result_data.address.city +
                    "</br><b>postal:</b> " +
                    result_data.address.postcode;
                new_addr =
                    road +
                    ", " +
                    result_data.address.house_number +
                    ", " +
                    result_data.address.city_district +
                    ", " +
                    result_data.address.city +
                    ", " +
                    result_data.address.postcode;
                var lat = myMarker.getLatLng().lat;
                var lon = myMarker.getLatLng().lng;
                var czoom = map.getZoom();
                if (czoom < 18) {
                    nzoom = czoom + 2;
                }
                if (nzoom > 18) {
                    nzoom = 18;
                }
                if (czoom != 18) {
                    map.setView([lat, lon], nzoom);
                } else {
                    map.setView([lat, lon]);
                }
                document.getElementById("lat").value = lat;
                document.getElementById("lon").value = lon;
                document.getElementById("addr").value = new_addr;
                myMarker.bindPopup(popup_text).openPopup();
            });
        });

    function chooseAddr(lat1, lng1) {
        myMarker.closePopup();
        map.setView([lat1, lng1], 18);
        myMarker.setLatLng([lat1, lng1]);
        lat = lat1.toFixed(8);
        lon = lng1.toFixed(8);
        // OSM Nomitatim documentation: http://wiki.openstreetmap.org/wiki/Nominatim
        var jsonQuery =
            "http://nominatim.openstreetmap.org/reverse?format=json&lat=" +
            myMarker.getLatLng().lat +
            "&lon=" +
            myMarker.getLatLng().lng +
            "&zoom=18&addressdetails=1";
        $.getJSON(jsonQuery).done(function (result_data) {
            console.log(result_data);

            var road;

            if (result_data.address.road) {
                road = result_data.address.road;
            } else if (result_data.address.pedestrian) {
                road = result_data.address.pedestrian;
            } else {
                road = "Not defined!";
            }
            var popup_text =
                "<b>Lat-lng:</b> " +
                myMarker.getLatLng().lat +
                ", " +
                myMarker.getLatLng().lng +
                // "</br><b>Address:</b> " + result_data.address +

                "</br><b>road</b> " +
                road +
                ", " +
                result_data.address.house_number +
                "</br><b>District</b> " +
                result_data.address.city_district +
                "</br><b>City:</b> " +
                result_data.address.city +
                "</br><b>postal:</b> " +
                result_data.address.postcode;
            //  myMarker.closePopup();
            //  map.setView([lat1, lng1],18);
            //  myMarker.setLatLng([lat1, lng1]);
            //  lat = lat1.toFixed(8);
            //  lon = lng1.toFixed(8);
            document.getElementById("lat").value = lat;
            document.getElementById("lon").value = lon;
            myMarker.bindPopup(popup_text).openPopup();
            //  myMarker.bindPopup("Lat " + lat + "<br />Lon " + lon).openPopup();
        });
    }

    function myFunction(arr) {
        var out = "<br />";
        var i;

        if (arr.length > 0) {
            for (i = 0; i < arr.length; i++) {
                out +=
                    "<div class='address' title='Show Location and Coordinates' onclick='chooseAddr(" +
                    arr[i].lat +
                    ", " +
                    arr[i].lon +
                    ");return false;'>" +
                    arr[i].display_name +
                    "</div>";
            }
            document.getElementById("results").innerHTML = out;
        } else {
            document.getElementById("results").innerHTML =
                "Sorry, no results...";
        }
    }

    function addr_search() {
        var inp = document.getElementById("addr");
        var xmlhttp = new XMLHttpRequest();
        var url =
            "https://nominatim.openstreetmap.org/search?format=json&limit=3&q=" +
            inp.value;
        xmlhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                var myArr = JSON.parse(this.responseText);
                myFunction(myArr);
            }
        };
        xmlhttp.open("GET", url, true);
        xmlhttp.send();
    }
</script>
{% endblock %}